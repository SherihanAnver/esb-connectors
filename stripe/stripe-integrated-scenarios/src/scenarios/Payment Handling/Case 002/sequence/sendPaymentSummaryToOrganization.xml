<?xml version="1.0" encoding="UTF-8"?>
<sequence xmlns="http://ws.apache.org/ns/synapse" name="sendPaymentSummaryToOrganization">
   <!-- Build the HTML Message to be sent via Mandrill. -->
   <filter xpath="get-property('operation','emailString') != '' and get-property('operation','totalAmount') != ''">
      <then>
		 <property name="emailString" expression="get-property('operation', 'emailString')" />
         <property name="totalAmount" expression="get-property('operation', 'totalAmount')" />
         <!-- Build the HTML to send the summary to the organization. This function is not included in the previous script mediator to avoid possible racing condition between threads of different iterators.-->
         <script language="js">
			<![CDATA[
				 var emailString = mc.getProperty('emailString');	
				 var totalAmount = mc.getProperty('totalAmount');
				 var fromName = mc.getProperty('stripe.fromName');
				 															
				 var htmlString = "<html><body><p>Hi <b>" + fromName + "</b>,</p></br></br><p>Here's some wonderful news for you. Your organization has received a total payment of US$ " + totalAmount + " from the following customers. Have fun!</p></br></br><table  border='1'><tr><th>Customer</th><th>Amount (US$)</th></tr>" + emailString + "<tr><td>Total</td><td align='right'><b>" + totalAmount + "</b></td></tr></table></br></br><p>Please do not respond to this mail as it was auto-generated by our system.</p></body></html>";																			
				 mc.setProperty('mandrill.mailContent', htmlString);
			 ]]>
		 </script>
         
         <property name="stripe.to" expression="fn:concat('[{&quot;email&quot;:&quot;', get-property('stripe.fromEmail'), '&quot;,&quot;name&quot;:&quot;', get-property('stripe.fromName'), '&quot;,&quot;type&quot;:&quot;to&quot;}]')" />
         
		 <!-- Send the message to the customer via Mandrill. -->
         <mandrill.init>
            <apiKey>{$ctx:mandrill.apiKey}</apiKey>
            <apiUrl>{$ctx:mandrill.apiUrl}</apiUrl>
            <format>json</format>
         </mandrill.init>
         <mandrill.sendMessage>
            <html>{$ctx:mandrill.mailContent}</html>
            <subject>Cheers! You've been paid!</subject>
            <fromEmail>books@zoho.com</fromEmail>
            <fromName>ZohoBooks Team</fromName>
            <important>true</important>
            <to>{$ctx:stripe.to}</to>
         </mandrill.sendMessage>
		 
         <property name="mandrill.status" expression="//jsonArray/jsonElement/status/text()" />
         <property name="mandrill.id" expression="//jsonArray/jsonElement/_id/text()" />
		 
         <!-- If the message is either sent or queued, send a success response to user. -->
         <filter xpath="get-property('mandrill.status') = 'sent' or get-property('mandrill.status') = 'queued'">
            <then>
               <property name="id" expression="fn:concat('mandrill_messageId:', get-property('mandrill.id'))" />
               <property name="status" value="Success" />
               <property name="message" value="Summary of the payments has been emailed to the organization." />
            </then>
            <else>
               <!-- Failure case: Append an error message to be sent to the user. -->
               <property name="id" value="{}" />
               <property name="status" value="Failure" />
               <property name="message" expression="json-eval($)" />
            </else>
         </filter>
         <call-template target="responseHandlerTemplate">
            <with-param name="activity" value="mandrill_sendSummaryEmailToOrganization" />
            <with-param name="id" value="{$ctx:id}" />
            <with-param name="status" value="{$ctx:status}" />
            <with-param name="message" value="{$ctx:message}" />
         </call-template>
      </then>
   </filter>
</sequence>
